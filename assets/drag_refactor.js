var Drag=new Class({Implements:[Events,Options],options:{snap:6,unit:"px",grid:!1,style:!0,limit:!1,handle:!1,invert:!1,preventDefault:!1,stopPropagation:!1,modifiers:{x:"left",y:"top"}},initialize:function(){var t=Array.link(arguments,{options:Type.isObject,element:function(t){return null!=t}});this.element=document.id(t.element),this.document=this.element.getDocument(),this.setOptions(t.options||{});var e=typeOf(this.options.handle);this.handles=("array"==e||"collection"==e?$$(this.options.handle):document.id(this.options.handle))||this.element,this.mouse={now:{},pos:{}},this.value={start:{},now:{}},this.selection=Browser.ie?"selectstart":"mousedown",Browser.ie&&!Drag.ondragstartFixed&&(document.ondragstart=Function.from(!1),Drag.ondragstartFixed=!0),this.bound={start:this.start.bind(this),check:this.check.bind(this),drag:this.drag.bind(this),stop:this.stop.bind(this),cancel:this.cancel.bind(this),eventStop:Function.from(!1)},this.attach()},attach:function(){return this.handles.addEvent("mousedown",this.bound.start),this},detach:function(){return this.handles.removeEvent("mousedown",this.bound.start),this},start:function(t){var e=this.options;if(!t.rightClick){e.preventDefault&&t.preventDefault(),e.stopPropagation&&t.stopPropagation(),this.mouse.start=t.page,this.fireEvent("beforeStart",this.element);var i,s,o=e.limit;for(i in this.limit={x:[],y:[]},e.modifiers)if(e.modifiers[i]){var n=this.element.getStyle(e.modifiers[i]);if(n&&!n.match(/px$/)&&(s||(s=this.element.getCoordinates(this.element.getOffsetParent())),n=s[e.modifiers[i]]),e.style?this.value.now[i]=(n||0).toInt():this.value.now[i]=this.element[e.modifiers[i]],e.invert&&(this.value.now[i]*=-1),this.mouse.pos[i]=t.page[i]-this.value.now[i],o&&o[i])for(var h=2;h--;){var u=o[i][h];(u||0===u)&&(this.limit[i][h]="function"==typeof u?u():u)}}"number"==typeOf(this.options.grid)&&(this.options.grid={x:this.options.grid,y:this.options.grid});var r={mousemove:this.bound.check,mouseup:this.bound.cancel};r[this.selection]=this.bound.eventStop,this.document.addEvents(r)}},check:function(t){this.options.preventDefault&&t.preventDefault(),Math.round(Math.sqrt(Math.pow(t.page.x-this.mouse.start.x,2)+Math.pow(t.page.y-this.mouse.start.y,2)))>this.options.snap&&(this.cancel(),this.document.addEvents({mousemove:this.bound.drag,mouseup:this.bound.stop}),this.fireEvent("start",[this.element,t]).fireEvent("snap",this.element))},drag:function(t){var e=this.options;for(var i in e.preventDefault&&t.preventDefault(),this.mouse.now=t.page,e.modifiers)e.modifiers[i]&&(this.value.now[i]=this.mouse.now[i]-this.mouse.pos[i],e.invert&&(this.value.now[i]*=-1),e.limit&&this.limit[i]&&((this.limit[i][1]||0===this.limit[i][1])&&this.value.now[i]>this.limit[i][1]?this.value.now[i]=this.limit[i][1]:(this.limit[i][0]||0===this.limit[i][0])&&this.value.now[i]<this.limit[i][0]&&(this.value.now[i]=this.limit[i][0])),e.grid[i]&&(this.value.now[i]-=(this.value.now[i]-(this.limit[i][0]||0))%e.grid[i]),e.style?this.element.setStyle(e.modifiers[i],this.value.now[i]+e.unit):this.element[e.modifiers[i]]=this.value.now[i]);this.fireEvent("drag",[this.element,t])},cancel:function(t){this.document.removeEvents({mousemove:this.bound.check,mouseup:this.bound.cancel}),t&&(this.document.removeEvent(this.selection,this.bound.eventStop),this.fireEvent("cancel",this.element))},stop:function(t){var e={mousemove:this.bound.drag,mouseup:this.bound.stop};e[this.selection]=this.bound.eventStop,this.document.removeEvents(e),t&&this.fireEvent("complete",[this.element,t])}});Class.refactor=function(t,e){return Object.each(e,function(e,i){var s=t.prototype[i];s=s&&s.$origin||s||function(){},t.implement(i,"function"==typeof e?function(){var t=this.previous;this.previous=s;var i=e.apply(this,arguments);return this.previous=t,i}:e)}),t},Class.refactor(Drag,{attach:function(){return this.handles.addEvent("touchstart",this.bound.start),this.handles.addEvent("keydown",this.bound.start),this.previous.apply(this,arguments)},detach:function(){return this.handles.removeEvent("touchstart",this.bound.start),this.handles.removeEvent("keydown",this.bound.start),this.previous.apply(this,arguments)},start:function(t){if(this.mouse.start=void 0!==t.page.x?t.page:null,null===this.mouse.start){let t=this.element.getCoordinates();this.mouse.start={x:t.left,y:t.top}}var e,i,s=this.options.limit;for(e in this.limit={x:[],y:[]},this.options.modifiers)if(this.options.modifiers[e]){var o=this.element.getStyle(this.options.modifiers[e]);if(o&&!o.match(/px$/)&&(i||(i=this.element.getCoordinates(this.element.getOffsetParent())),o=i[this.options.modifiers[e]]),this.options.style?this.value.now[e]=(o||0).toInt():this.value.now[e]=this.element[this.options.modifiers[e]],this.options.invert&&(this.value.now[e]*=-1),this.mouse.pos[e]=this.mouse.start[e]-this.value.now[e],s&&s[e])for(var n=2;n--;){var h=s[e][n];(h||0===h)&&(this.limit[e][n]="function"==typeof h?h():h)}}"number"==typeOf(this.options.grid)&&(this.options.grid={x:this.options.grid,y:this.options.grid}),"touchstart"==t.type&&document.body.addEvents({touchmove:this.bound.check,touchend:this.bound.cancel}),"mousedown"==t.type&&document.addEvents({mousemove:this.bound.check,mouseup:this.bound.cancel}),("keydown"==t.type&&"left"==t.key||"right"==t.key)&&document.getElements(".cf_filtering_slide_container").addEvents({keydown:this.bound.check,keyup:this.bound.cancel})},check:function(t){this.options.preventDefault&&t.preventDefault();let e="mousmove"==t.type?t.page.x:"right"!=t.key?this.mouse.start.x-3:this.mouse.start.x+3;Math.round(Math.sqrt(Math.pow(e-this.mouse.start.x,2)))>=this.options.snap&&(this.cancel(),"keydown"==t.type?document.addEvents({keydown:this.bound.drag,keyup:this.bound.stop}):document.body.addEvents({touchmove:this.bound.drag,touchend:this.bound.stop,mousemove:this.bound.drag,mouseup:this.bound.stop}))},drag:function(t){var e=this.options;if(e.preventDefault&&t.preventDefault(),this.mouse.now=void 0!==t.page.x?t.page:null,null===this.mouse.now){let e=this.element.getCoordinates();e.left="right"!=t.key?e.left-3:e.left+3,this.mouse.now={x:e.left,y:e.top}}for(var i in e.modifiers)e.modifiers[i]&&(this.value.now[i]=this.mouse.now[i]-this.mouse.pos[i],e.invert&&(this.value.now[i]*=-1),e.limit&&this.limit[i]&&((this.limit[i][1]||0===this.limit[i][1])&&this.value.now[i]>this.limit[i][1]?this.value.now[i]=this.limit[i][1]:(this.limit[i][0]||0===this.limit[i][0])&&this.value.now[i]<this.limit[i][0]&&(this.value.now[i]=this.limit[i][0])),e.grid[i]&&(this.value.now[i]-=(this.value.now[i]-(this.limit[i][0]||0))%e.grid[i]),e.style?this.element.setStyle(e.modifiers[i],this.value.now[i]+e.unit):this.element[e.modifiers[i]]=this.value.now[i]);this.fireEvent("drag",[this.element,t])},cancel:function(t){return document.body.removeEvents({touchmove:this.bound.check,touchend:this.bound.cancel}),document.getElements(".cf_filtering_slide_container").removeEvents({keydown:this.bound.check,keyup:this.bound.cancel}),this.previous.apply(this,arguments)},stop:function(t){return document.body.removeEvents({touchmove:this.bound.drag,touchend:this.bound.stop,mousemove:this.bound.drag,mouseup:this.bound.stop}),document.removeEvents({keydown:this.bound.drag,keyup:this.bound.stop}),this.previous.apply(this,arguments)}});
